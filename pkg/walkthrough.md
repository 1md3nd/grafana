# Server startup

For starting the server for development one can use the following [make](../Makefile#L156) command:
`make run`
This command uses the [bra](https://github.com/unknwon/bra) tool that [is configured](../.bra.toml) detects changes in the code and restarts the server. More specifically:
- Generates code for connecting components using dependency injection using [wire](https://github.com/google/wire). An example for creating a service can be found [here](https://github.com/grafana/grafana/blob/main/contribute/backend/services.md#services).
The output of this step is [wire_gen.go](./server/wire_gen.go)
- Builds grafana
- Creates dev dashboards JSONs using jsonnet. This [dev script](../devenv/setup.sh) creates a link to the location the provisioning service is configured to search for resources.
- Starts the grafana server

The grafana binary supports several commands:
```
$ ./bin/grafana --help
NAME:
   grafana - Grafana server and command line interface

USAGE:
   grafana [global options] command [command options] [arguments...]

VERSION:
   11.0.0-pre

AUTHOR:
   Grafana Project <hello@grafana.com>

COMMANDS:
   cli        run the grafana cli
   server     run the grafana server
   apiserver  run a standalone api service (experimental)
   server     run the grafana server
   help, h    Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --help, -h     show help
   --version, -v  print the version
```

For starting the server we use [`./bin/grafana server`](./cmd/grafana-server/commands/cli.go)


- setups [profiling](./cmd/grafana-server//commands/cli.go#L82) & [tracing](./cmd/grafana-server//commands/cli.go#L85) if enabled
- handles failures by attempting [recovering](./cmd/grafana-server//commands/cli.go#L96) from them
- [loads configuration](./cmd/grafana-server//commands/cli.go#L107)
- initializes the server by calling the generated by wire [Initialize()](server/wire_gen.go#L237)
- [starts background services](./server/server.go#L149)

Additionally there is option [to target specific, registered dskit modules](https://github.com/grafana/grafana/pull/74408). This is similar from the above except that is calls generate by wire [InitializeModuleServer()](./server/wire_gen.go#L1163). Details about dskit sercices CAN 


The background services implement the [BackgroundService](./registry/registry.go#L25) interface and are registered [here](./registry/backgroundsvcs/background_services.go).

# Configuration

Configuration is applied in the following order:
- [file configuration](./setting/setting.go#L1392); there are [defaults](../conf/defaults.ini) for each configuration that users can override in the configuration file that is located in [`$WORKING_DIR/conf/custom.ini` or `/usr/local/etc/grafana/grafana.ini`](https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/#configuration-file-location)
- [command line properties](./setting/setting.go#L1396)
- [environment variables](./setting/setting.go#L1403)

# Support for different SQL backends

We support all three backends: SQLite, MySQL, PostgreSQL. By default SQLite is used. The SQLite file is named `grafana.db` and is located in [[paths.data]](../conf/defaults.ini) directory.

Command to start grafana with MySQL you can use this command:
```
GF_DATABASE_TYPE=mysql \
GF_DATABASE_HOST=127.0.0.1:3306 \
GF_DATABASE_USER=grafana \
GF_DATABASE_PASSWORD=password \
make run"
```

> To quickly launch a MySQL server one can use the respective [devenv block](../devenv/README.md#docker-compose-with-databases) by running:
```
make devenv sources=mysql
```

Command to start grafana with PostgreSQL you can use this command:
```
GF_DATABASE_TYPE=postgres \
GF_DATABASE_HOST=127.0.0.1:5432 \
GF_DATABASE_USER=grafana \
GF_DATABASE_PASSWORD=password \
make run
```

> To quickly launch a PostgreSQL server one can use the respective [devenv block](../devenv/README.md#docker-compose-with-databases) by running:
```
make devenv sources=postgres
```

# Testing

To run the unit and integration tests using the default (SQLite) backend use:
[`make test-go`](../Makefile#L165)

## [Unit testing](https://github.com/grafana/grafana/blob/main/contribute/backend/style-guide.md#test-suite-and-database-tests)

Each package SHOULD include a [TestMain](https://pkg.go.dev/testing#hdr-Main) function that calls [testsuite.Run(m)](tests/testsuite/testsuite.go#L10) that:
- setups test database
- runs the suite
- cleanups the test database

## [Integration testing](https://github.com/grafana/grafana/blob/main/contribute/backend/style-guide.md#integration-tests)

To create a test database we call [InitTestDB()](./services/sqlstore/sqlstore.go#L426); this initializes and returns a SQLStore with the targeted backend. More specifically:
- [connects to the DB server](./services/sqlstore/sqlstore.go#L574)
- [runs the migrations](./services/sqlstore/sqlstore.go#L589)
- [truncates DB tables](./services/sqlstore/sqlstore.go#L597)
- [creates admin org and user](./services/sqlstore/sqlstore.go#L171)

By default SQLite is used unless `GRAFANA_TEST_DB` is set. For the SQLite test database is used [a temporary file](./services/sqlstore/sqlutil/sqlutil.go#L85).

To run integration tests agianst MySQL use:
[`test-go-integration-mysql`](../Makefile#L193)

> To quickly launch a MySQL test server one can use the respective [devenv block](../devenv/README.md#docker-compose-with-databases) by running:
```
make devenv sources=mysql_tests
```

To run integration tests agianst Postgres use:
[`test-go-integration-postgres`](../Makefile#L186)

> To quickly launch a PostgreSQL test server one can use the respective [devenv block](../devenv/README.md#docker-compose-with-databases) by running:
```
make devenv sources=postgres_tests
```

## API testing

For API testing we use a hybrid approch. There are some API tests located in [pkg/api](./pkg/api) package that create a test [HTTP server](./web/webtest/webtest.go#L30).
There are also some API tests under [pkg/tests/api](./tests/api/) that start [a grafana server](./tests/api/prometheus/prometheus_test.go#L35) using [testinfra.StartGrafanaEnv()](./tests/testinfra/testinfra.go#L41) and tests interact with it by sending HTTP requests to this address.
[Some more recent tests](./tests/api/folders/api_folder_test.go#L82) the use the [Go client](https://github.com/grafana/grafana-openapi-client-go) for . This client is generated by [the OpenAPI specifications](./api/README.md).

# CI

For CI we use [drone](https://www.drone.io/). We have different pipelines for running for PRs, when a commit is merged to `main` branch, for creating releases etc.
Instructions for making changes in the drone pipelines are [here](../contribute/drone-pipeline.md).

# HTTP Server

API Routes are registered [here](./api/api.go). Preferably, newly introduced routes should live inside the service package. For a service to be able to register its routes should have [RouteRegister](./api/routing/route_register.go#L18)

# Assisting tools

The `bra` and `wire` binaries are installed using [bingo](https://github.com/bwplotka/bingo) which downloads and installs all the tools needed. The list of the tools currently installed in my machine is the following:
```
$ bingo list
Name            Binary Name                             Package @ Version                                               Build EnvVars   Build Flags
----            -----------                             -----------------                                               -------------   -----------
bra             bra-v0.0.0-20200517080246-1e3013ecaff8  github.com/unknwon/bra@v0.0.0-20200517080246-1e3013ecaff8
cue             cue-v0.5.0                              cuelang.org/go/cmd/cue@v0.5.0
drone           drone-v1.5.0                            github.com/drone/drone-cli/drone@v1.5.0                         CGO_ENABLED=0
golangci-lint   golangci-lint-v1.53.3                   github.com/golangci/golangci-lint/cmd/golangci-lint@v1.53.3
jb              jb-v0.5.1                               github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb@v0.5.1
lefthook        lefthook-v1.4.8                         github.com/evilmartians/lefthook@v1.4.8
swagger         swagger-v0.30.2                         github.com/go-swagger/go-swagger/cmd/swagger@v0.30.2
wire            wire-v0.6.0                             github.com/google/wire/cmd/wire@v0.6.0
```

# Resources

- [Contribute guidelines](https://github.com/grafana/grafana/blob/main/contribute/README.md)
- [Developer Guide](https://github.com/grafana/grafana/blob/main/contribute/developer-guide.md#developer-guide)
- [Backend style guide](https://github.com/grafana/grafana/blob/main/contribute/backend/style-guide.md#backend-style-guide)
- [Backend notes](https://github.com/grafana/grafana/blob/main/contribute/backend/README.md)
- [dskit Services](https://github.com/grafana/dskit/tree/main/services#using-basicservice-struct)
- [Service file structure](https://docs.google.com/presentation/d/1q4ZwThW2d6wgmreG1dhAK0HlocajKZlT4qENxSonf2Q/edit#slide=id.g11a5b02ed18_0_59)
- [Errors](https://github.com/grafana/grafana/blob/main/contribute/backend/errors.md)
- [Instrumenting Grafana](../contribute/backend/instrumentation.md)
- [CODEOWNERS](../.github/CODEOWNERS)